<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baseball API - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">Baseball API Dashboard</span>
            <div class="d-flex">
                {{if .User}}
                <span class="navbar-text me-3 text-light">
                    {{if .User.AvatarURL}}<img src="{{.User.AvatarURL}}" class="rounded-circle me-2" width="32" height="32">{{end}}
                    {{.User.Email}}
                </span>
                <button class="btn btn-outline-light" hx-post="/v1/auth/logout" hx-swap="none" onclick="window.location.href='/login'">Logout</button>
                {{else}}
                <a href="/login" class="btn btn-outline-light">Login</a>
                {{end}}
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {{if .User}}
        <div class="row">
            <div class="col-md-12">
                <h2>API Keys</h2>
                <p class="text-muted">Generate and manage API keys for programmatic access to the Baseball API.</p>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Generate New API Key</h5>
                    </div>
                    <div class="card-body">
                        <form id="create-key-form">
                            <div class="mb-3">
                                <label for="key-name" class="form-label">Key Name (Optional)</label>
                                <input type="text" class="form-control" id="key-name" name="name" placeholder="e.g., Production Server">
                            </div>
                            <button type="submit" class="btn btn-primary">Generate Key</button>
                        </form>
                        <div id="new-key-result" class="mt-3"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Your API Keys</h5>
                    </div>
                    <div class="card-body" id="api-keys-list">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {{else}}
        <div class="alert alert-warning">
            You must be logged in to access the dashboard. <a href="/login">Login here</a>.
        </div>
        {{end}}
    </div>

    <script>
        function loadAPIKeys() {
            fetch('/v1/auth/keys')
                .then(res => res.json())
                .then(keys => {
                    const container = document.getElementById('api-keys-list');
                    if (!keys || keys.length === 0) {
                        container.innerHTML = '<p class="text-muted">No API keys yet. Generate one above to get started.</p>';
                        return;
                    }

                    const html = keys.map(key => {
                        const createdAt = new Date(key.created_at).toLocaleString();
                        const lastUsed = key.last_used_at ? new Date(key.last_used_at).toLocaleString() : 'Never';
                        const expires = key.expires_at ? new Date(key.expires_at).toLocaleString() : 'Never';
                        const status = key.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-danger">Revoked</span>';

                        return ` + "`" + `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="card-title">${key.name || 'Unnamed Key'}</h6>
                                            <p class="card-text text-muted mb-1">
                                                <small>Prefix: <code>${key.key_prefix}...</code></small><br>
                                                <small>Created: ${createdAt}</small><br>
                                                <small>Last Used: ${lastUsed}</small><br>
                                                <small>Expires: ${expires}</small>
                                            </p>
                                            ${status}
                                        </div>
                                        ${key.is_active ? ` + "`" + `<button class="btn btn-sm btn-danger" onclick="revokeKey('${key.id}')">Revoke</button>` + "`" + ` : ''}
                                    </div>
                                </div>
                            </div>
                        ` + "`" + `;
                    }).join('');

                    container.innerHTML = html;
                })
                .catch(err => {
                    console.error('Error loading keys:', err);
                    document.getElementById('api-keys-list').innerHTML = '<p class="text-danger">Failed to load API keys.</p>';
                });
        }

        function revokeKey(id) {
            if (!confirm('Are you sure you want to revoke this API key? This action cannot be undone.')) {
                return;
            }

            fetch(` + "`" + `/v1/auth/keys/${id}` + "`" + `, { method: 'DELETE' })
                .then(res => res.json())
                .then(() => {
                    loadAPIKeys();
                })
                .catch(err => {
                    alert('Failed to revoke key: ' + err.message);
                });
        }

        document.getElementById('create-key-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const name = document.getElementById('key-name').value || null;

            fetch('/v1/auth/keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            })
                .then(res => res.json())
                .then(data => {
                    const resultDiv = document.getElementById('new-key-result');
                    resultDiv.innerHTML = ` + "`" + `
                        <div class="alert alert-success">
                            <h6>API Key Created!</h6>
                            <p class="mb-2">Please save this key securely. It will only be shown once:</p>
                            <div class="input-group">
                                <input type="text" class="form-control" value="${data.key}" id="new-key-value" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyKey()">Copy</button>
                            </div>
                            <small class="text-muted">${data.warning}</small>
                        </div>
                    ` + "`" + `;

                    document.getElementById('key-name').value = '';
                    loadAPIKeys();

                    setTimeout(() => {
                        resultDiv.innerHTML = '';
                    }, 60000);
                })
                .catch(err => {
                    document.getElementById('new-key-result').innerHTML = ` + "`" + `
                        <div class="alert alert-danger">Failed to create API key: ${err.message}</div>
                    ` + "`" + `;
                });
        });

        function copyKey() {
            const input = document.getElementById('new-key-value');
            input.select();
            document.execCommand('copy');

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }

        {{if .User}}
        loadAPIKeys();
        {{end}}
    </script>
</body>
</html>
